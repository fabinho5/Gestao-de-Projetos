name: Backend CI

on:
  push:
    branches: [ "main", "dev", "tests" ]
  pull_request:
    branches: [ "main", "dev", "tests" ]

jobs:
  backend-tests:
    runs-on: ubuntu-latest
    # When repository secrets aren't available for you, we can run a disposable
    # MySQL service inside the job and point Prisma to it. This avoids needing
    # to set repository secrets while keeping the DB close to the real schema
    # (the project uses MySQL in prisma/schema.prisma).
    services:
      mysql:
        image: mysql:8
        env:
          MYSQL_ROOT_PASSWORD: password
          MYSQL_DATABASE: testdb
        ports:
          - 3306:3306
        options: >-
          --health-cmd="mysqladmin ping --silent"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=10

    env:
      NODE_ENV: test
      # Point to the MySQL service created above. This avoids using secrets.
      DATABASE_URL: mysql://root:password@127.0.0.1:3306/testdb
      JWT_SECRET: test_jwt_secret

    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm
          cache-dependency-path: backend/package-lock.json

      - name: Install dependencies
        working-directory: backend
        run: npm install

      - name: Install mysql client (used to wait for DB)
        run: sudo apt-get update && sudo apt-get install -y default-mysql-client
        working-directory: backend

      - name: Wait for MySQL to be ready
        working-directory: backend
        run: |
          for i in {1..30}; do
            if mysql -h 127.0.0.1 -P 3306 -u root -ppassword -e 'SELECT 1' >/dev/null 2>&1; then
              echo 'MySQL is up';
              exit 0
            fi
            echo 'Waiting for MySQL...';
            sleep 2
          done
          echo 'MySQL did not become ready in time' && exit 1

      - name: Prisma generate & migrate
        working-directory: backend
        run: |
          # Prisma generate occasionally runs the `prisma-erd-generator` which
          # invokes mermaid-cli (mmdc) and puppeteer. Puppeteer often fails in
          # CI due to sandboxing restrictions (Chromium can't start). The ERD
          # is a nicety and not required for tests, so tolerate generate errors
          # here and continue.
          npx prisma generate || echo "prisma generate failed (continuing)"
          npx prisma migrate deploy || true

      - name: Seed database
        working-directory: backend
        run: |
          # Run Prisma's configured seed script (uses tsx as configured in backend/prisma.seed)
          npx prisma db seed

      - name: Run tests
        working-directory: backend
        run: npm test