Audit Logging Module Notes
===========================
Last update: 2026-01-02

Summary
-------
- Added dedicated audit logging service (src/services/auditLog.service.ts) that centralizes writes and filtered queries while supporting Prisma transactions and pagination.
- Created admin-only controller/routes (src/controllers/auditLog.controller.ts, src/routes/auditLog.routes.ts) and registered them in src/app.ts under /audit-logs with role protection.
- Injected audit log recording into core flows: parts lifecycle (src/services/parts.service.ts + controllers), reservation workflow (src/services/reservations.service.ts), and every stock movement (src/services/stockMovement.service.ts).
- Ensured controllers forward the authenticated user id whenever an action writes audit data, guaranteeing traceability.

Why
---
- Requirement from module 5 to keep a tamper-resistant history of all sensitive operations with user attribution and filterable admin access.
- Central service avoids duplicated Prisma logic and makes it easy to add more audited flows later.
- Admin endpoints provide paginated, filter-rich visibility so compliance and warehouse managers can investigate incidents quickly.
- Tying logs to the same Prisma transaction as the business operation keeps data consistent (no operation without a log record).

Audit Action Reference
----------------------
- **PART_VISIBILITY**: Fired after `PATCH /parts/:ref/visibility` when `PartsService.setVisibility()` flips a part's `isVisible` flag.
- **PART_UPDATE**: Emitted whenever `PartsService.updatePart()` succeeds (typically `PATCH /parts/:ref`), capturing the changed fields.
- **PART_CREATE**: Recorded right after a new part is inserted via `PartsService.createPart()` (`POST /parts`).
- **PART_DELETE**: Generated when `PartsService.deletePart()` performs a soft delete (`DELETE /parts/:ref`).
- **RESERVATION_CREATE**: Logged during `ReservationsService.createReservation()` (`POST /reservations`).
- **RESERVATION_ASSIGN**: Triggered when a warehouse user takes ownership through `ReservationsService.assignReservation()`.
- **RESERVATION_STATUS**: Written whenever `ReservationsService.updateStatus()` transitions the reservation lifecycle.
- **RESERVATION_CANCEL**: Added when `ReservationsService.cancelReservation()` cancels with a provided reason/return location.
- **STOCK_ENTRY**: Produced inside `stockMovementService.recordEntry()` (initial creation or manual entry into a location).
- **STOCK_EXIT**: Captured by `recordExit()` when a reservation completion removes the part from inventory.
- **STOCK_TRANSFER**: Logged during `recordTransfer()` for moves between locations.
- **STOCK_RETURN**: Created by `recordReturn()` for both regular returns (with destination) and damaged returns (no destination).
- **STOCK_ADJUSTMENT**: Generated by `recordAdjustment()` whenever an admin corrects a part's stored location manually.
- **USER_UPDATE**: Fired when an admin edits another user via `UsersService.updateUser()`.
- **USER_DEACTIVATE**: Recorded when `UsersService.deactivateUser()` disables an account and clears refresh tokens.
- **USER_ACTIVATE**: Triggered when `UsersService.activateUser()` re-enables an account.
- **USER_CREATE**: Emitted from `AuthService.register()` whenever an admin provisions a new account.
- **USER_PASSWORD_CHANGE**: Logged inside `AuthService.changePassword()` after a user updates their own password.
- **USER_PASSWORD_RESET**: Recorded when `AuthService.adminResetPassword()` allows an admin to set a new password for someone else.

Thunder Client Test Matrix
--------------------------
Use an ADMIN token unless stated otherwise. For each request, duplicate it to try different filter/body combinations. All bodies are JSON unless indicated.

1. Auth / Session setup
   - POST http://localhost:3002/auth/login
     Body: { "username": "admin", "password": "<pwd>" }
     Save access token for later Authorization: Bearer <token>.

2. Parts lifecycle
   - POST http://localhost:3002/parts
     Body sample: {
       "name": "Filtro de Óleo",
       "refInternal": "TEST-001",
       "price": 25.5,
       "condition": "NEW",
       "categoryId": 1,
       "locationId": 1
     }
   - PATCH http://localhost:3002/parts/TEST-001
     Body: { "price": 27, "locationId": 2 }
   - PATCH http://localhost:3002/parts/TEST-001/visibility
     Body: { "isVisible": false }
   - DELETE http://localhost:3002/parts/TEST-001
   Expected: each action succeeds (201/200/200/204) and new audit entries appear with PART_* actions.

3. Reservations
   - POST http://localhost:3002/reservations
     Body: { "partId": <id>, "notes": "Pedido teste" }
   - PATCH http://localhost:3002/reservations/<id>/assign
     Body: { "warehouseUserId": 2 }
   - PATCH http://localhost:3002/reservations/<id>/status
     Body: { "status": "IN_PREPARATION" }
   - PATCH http://localhost:3002/reservations/<id>/cancel
     Body: { "reason": "DESIST" }
   Expected: RESERVATION_* logs with status transitions and cancel details.

4. Stock movements (direct calls if available)
   - POST http://localhost:3002/stock-movements/transfer
     Body: { "partId": <id>, "fromLocationId": 1, "toLocationId": 2 }
   - POST http://localhost:3002/stock-movements/return
     Body: { "partId": <id>, "toLocationId": 1, "isDamaged": false }
   - POST http://localhost:3002/stock-movements/adjustment
     Body: { "partId": <id>, "newLocationId": null }
   Expected: STOCK_TRANSFER / STOCK_RETURN / STOCK_ADJUSTMENT logs tied to movement ids.

5. User management
   - PATCH http://localhost:3002/users/5
     Body: { "fullName": "Andre Admin", "role": "WAREHOUSE" }
   - PATCH http://localhost:3002/users/5/deactivate
   - PATCH http://localhost:3002/users/5/activate
   Expected: USER_UPDATE / USER_DEACTIVATE / USER_ACTIVATE entries referencing the target user id.

6. Auth-admin actions
   - POST http://localhost:3002/auth/register
     Body: { "username": "newuser", "email": "new@demo.com", "fullName": "New User", "password": "Abc123", "role": "SALES" }
   - POST http://localhost:3002/auth/change-password (run as the created user with its own token)
     Body: { "oldPassword": "Abc123!@#", "newPassword": "Xpto456!@#" }
   - POST http://localhost:3002/auth/admin-reset-password
     Body: { "userId": <id>, "newPassword": "Reset789!@#" }
   Expected: USER_CREATE tied to the admin id, USER_PASSWORD_CHANGE tied to the acting user, and USER_PASSWORD_RESET tied to the admin + target.

7. Audit log exploration (ADMIN only)
   - GET http://localhost:3002/audit-logs?page=1&pageSize=20
   - GET http://localhost:3002/audit-logs?userId=1&action=PART&entity=PART
   - GET http://localhost:3002/audit-logs?search=TEST-001
   - GET http://localhost:3002/audit-logs?dateFrom=2025-12-31T00:00:00.000Z&dateTo=2026-01-02T23:59:59.000Z
   - GET http://localhost:3002/audit-logs/1
   Expected: responses contain pagination metadata plus nested user info; invalid filters return 400 with validation details.

Full Overnight Regression
-------------------------
Run the following chain in one sitting to confirm every log rolls in correctly (refresh tokens as needed between role switches):
1. Admin login ➜ capture token.
2. Parts lifecycle suite (section 2).
3. Reservations workflow (section 3).
4. Stock movement operations (section 4).
5. User management adjustments (section 5).
6. Auth-admin scenarios: admin creates a user, new user changes password, admin resets it again (section 6). Remember to log in as the new user for the self-service step.
7. Hit `/audit-logs` twice: once with broad filters, once scoped to each new action (e.g., `action=USER_CREATE`, `action=USER_PASSWORD_CHANGE`, etc.) to ensure every entry is persisted.
8. Note timestamps and request IDs—if any action is missing, re-run the corresponding endpoint immediately.

Execution Tips
--------------
- Free Thunder Client cannot share environments, so keep one tab per request; duplicate tabs to reuse headers.
- Always set the Authorization tab to Bearer and paste the latest access token; refresh tokens can be obtained through POST /auth/refresh if needed.
- For empty optional parameters (like dateFrom/dateTo) leave them out instead of sending blank strings to avoid validation errors.
- After running scenarios, hit GET /audit-logs to confirm the entries show the action/entity you triggered, with details matching request payloads.
